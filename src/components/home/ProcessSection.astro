---
import { homepageData } from "../../data/homepage";
import ButtonLink from "../ui/ButtonLink.astro";
import PlaceholderPanel from "../ui/PlaceholderPanel.astro";
import SectionHeading from "../ui/SectionHeading.astro";

interface Props {
  process: typeof homepageData.process;
}

const { process } = Astro.props;
const firstStep = process.steps[0];
---

<section
  id="process"
  class="section-shell bg-bg-soft/60"
  data-process-root
  data-steps={JSON.stringify(process.steps)}
>
  <div class="container-page">
    <div class="grid gap-8 lg:grid-cols-12">
      <div class="lg:col-span-4">
        <div class="lg:sticky lg:top-28">
          <SectionHeading title={process.title} description={process.intro} />
          <div class="mt-6">
            <ButtonLink href={process.cta.href} label={process.cta.label} />
          </div>
          <div class="surface-panel mt-6 p-5">
            <p class="editorial-caption">Aktivní krok procesu</p>
            <p class="mt-2 text-sm font-semibold text-text" data-process-step-index>
              01 / {String(process.steps.length).padStart(2, "0")}
            </p>
            <h3 class="mt-3 text-lg font-semibold" data-process-step-title>{firstStep.title}</h3>
            <p class="mt-2 text-sm leading-6 text-text-muted" data-process-step-description>
              {firstStep.description}
            </p>
            <div class="mt-5">
              <PlaceholderPanel label="Detail realizace / aktivní krok" ratio="landscape" />
            </div>
          </div>
          <ul class="mt-5 space-y-2 text-sm text-text-muted">
            <li class="flex items-start gap-2">
              <span class="mt-[8px] h-1.5 w-1.5 rounded-full bg-accent"></span>
              Jasný postup bez překvapení
            </li>
            <li class="flex items-start gap-2">
              <span class="mt-[8px] h-1.5 w-1.5 rounded-full bg-accent"></span>
              Výběr řešení podle konkrétního prostoru
            </li>
            <li class="flex items-start gap-2">
              <span class="mt-[8px] h-1.5 w-1.5 rounded-full bg-accent"></span>
              Důraz na kvalitu detailu i provedení
            </li>
          </ul>
        </div>
      </div>

      <div class="lg:col-span-8">
        <div class="hidden gap-4 lg:grid">
          {process.steps.map((step, index) => (
            <article
              class="process-step-card surface-panel grid gap-4 p-5 md:grid-cols-[auto_1fr_auto] md:items-start"
              data-step-card
              data-index={String(index)}
              data-active={index === 0 ? "true" : "false"}
            >
              <div class="flex h-9 w-9 items-center justify-center rounded-full bg-highlight text-sm font-semibold text-text">
                {index + 1}
              </div>
              <div>
                <h3 class="text-base font-semibold text-text">{step.title}</h3>
                <p class="mt-2 text-sm leading-6 text-text-muted">{step.description}</p>
              </div>
              <div class="hidden md:block">
                <PlaceholderPanel label={`Detail ${index + 1}`} ratio="square" class="w-28" />
              </div>
            </article>
          ))}
        </div>

        <div class="space-y-3 lg:hidden">
          {process.steps.map((step, index) => (
            <details class="surface-panel group p-0" open={index === 0}>
              <summary class="focus-ring flex list-none cursor-pointer items-center justify-between gap-4 rounded-lg px-5 py-4 text-left">
                <span class="text-sm font-semibold text-text">
                  {index + 1}. {step.title}
                </span>
                <span class="inline-flex h-6 w-6 items-center justify-center rounded-full border hairline text-text-muted transition group-open:rotate-45">
                  +
                </span>
              </summary>
              <div class="space-y-4 px-5 pb-5">
                <p class="text-sm leading-6 text-text-muted">{step.description}</p>
                <PlaceholderPanel label={`Detail ${index + 1}`} ratio="landscape" />
              </div>
            </details>
          ))}
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const root = document.querySelector<HTMLElement>("[data-process-root]");

  if (root && root.dataset.bound !== "true") {
    root.dataset.bound = "true";
    const steps = JSON.parse(root.dataset.steps || "[]");
    const cards = Array.from(root.querySelectorAll<HTMLElement>("[data-step-card]"));
    const indexEl = root.querySelector<HTMLElement>("[data-process-step-index]");
    const titleEl = root.querySelector<HTMLElement>("[data-process-step-title]");
    const descriptionEl = root.querySelector<HTMLElement>("[data-process-step-description]");

    if (steps.length && cards.length) {
      const setActive = (index: number) => {
        const safeIndex = Math.max(0, Math.min(steps.length - 1, index));
        const step = steps[safeIndex];

        if (indexEl) indexEl.textContent = `${String(safeIndex + 1).padStart(2, "0")} / ${String(steps.length).padStart(2, "0")}`;
        if (titleEl) titleEl.textContent = step.title;
        if (descriptionEl) descriptionEl.textContent = step.description;

        cards.forEach((card, cardIndex) => {
          const active = cardIndex === safeIndex;
          card.dataset.active = active ? "true" : "false";
        });
      };

      setActive(0);

      if ("IntersectionObserver" in window) {
        const observer = new IntersectionObserver(
          (entries) => {
            if (!window.matchMedia("(min-width: 1024px)").matches) return;

            let best: IntersectionObserverEntry | null = null;
            entries.forEach((entry) => {
              if (!entry.isIntersecting) return;
              if (!best || entry.intersectionRatio > best.intersectionRatio) best = entry;
            });

            if (!best) return;
            const el = best.target as HTMLElement;
            const index = Number(el.dataset.index || "0");
            setActive(index);
          },
          { threshold: [0.25, 0.5, 0.75], rootMargin: "-20% 0px -35% 0px" },
        );

        cards.forEach((card) => observer.observe(card));
      }
    }
  }
</script>

<style>
  .process-step-card {
    transition:
      border-color 180ms ease,
      transform 180ms ease,
      box-shadow 180ms ease;
  }

  .process-step-card[data-active="true"] {
    border-color: rgba(183, 140, 90, 0.32);
    box-shadow: var(--shadow-card);
    transform: translateY(-2px);
  }
</style>
