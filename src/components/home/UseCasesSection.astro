---
import { homepageData } from "../../data/homepage";
import SectionHeading from "../ui/SectionHeading.astro";

interface Props {
  useCases: typeof homepageData.useCases;
}

const { useCases } = Astro.props;
const active = useCases.items[0];
---

<section
  id="use-cases"
  class="section-shell"
  data-usecases-root
  data-items={JSON.stringify(useCases.items)}
>
  <div class="container-page">
    <SectionHeading title={useCases.title} description={useCases.intro} />

    <div class="mt-8 grid gap-8 lg:grid-cols-12 lg:items-start">
      <div class="lg:col-span-5">
        <div
          class="mb-5 flex flex-wrap gap-2"
          role="tablist"
          aria-label="Typy prostorů"
          data-usecase-tablist
        >
          {useCases.items.map((item, idx) => (
            <button
              type="button"
              id={`usecase-tab-${idx}`}
              role="tab"
              aria-selected={idx === 0 ? "true" : "false"}
              aria-controls="usecase-panel"
              tabindex={idx === 0 ? "0" : "-1"}
              data-usecase-tab
              data-index={String(idx)}
              class:list={[
                "chip focus-ring cursor-pointer transition",
                idx === 0 && "chip-active",
              ]}
            >
              {item.name}
            </button>
          ))}
        </div>

        <div
          id="usecase-panel"
          class="surface-panel p-5 transition-opacity duration-200"
          role="tabpanel"
          aria-labelledby="usecase-tab-0"
          tabindex="0"
          data-usecase-panel
        >
          <h3 class="text-lg font-semibold" data-usecase-title>{active.name}</h3>
          <p class="mt-3 text-sm leading-6 text-text-muted" data-usecase-description>
            {active.description}
          </p>
          <ul class="bullet-list mt-5" data-usecase-bullets>
            {active.bullets.map((bullet) => (
              <li>{bullet}</li>
            ))}
          </ul>
          <p class="editorial-caption mt-6">
            Task 02: přístupné tabs s klávesnicí (šipky vlevo/vpravo, Home/End)
          </p>
        </div>
      </div>

      <div class="lg:col-span-7">
        <div class="surface-panel overflow-hidden shadow-card">
          <div class="relative aspect-[4/5] p-4">
            <img
              src={active.image}
              alt={`Ukázka prostoru: ${active.name}`}
              class="h-full w-full rounded-md object-cover object-center"
              loading="lazy"
              decoding="async"
              data-usecase-image
            />
            <div class="absolute inset-4 rounded-md bg-gradient-to-t from-black/24 via-transparent to-transparent"></div>
            <div class="absolute inset-x-4 bottom-4 rounded-md border hairline bg-surface/85 p-3 backdrop-blur">
              <p class="editorial-caption">Aktivní use case</p>
              <p class="mt-2 text-sm font-medium text-text" data-usecase-image-label>
                {active.imageLabel}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script is:inline>
  (() => {
    const root = document.querySelector("[data-usecases-root]");
    if (!root || root.dataset.bound === "true") return;
    root.dataset.bound = "true";

    const items = JSON.parse(root.dataset.items || "[]");
    if (!Array.isArray(items) || items.length === 0) return;

    const tabs = Array.from(root.querySelectorAll("[data-usecase-tab]"));
    const panel = root.querySelector("[data-usecase-panel]");
    const titleEl = root.querySelector("[data-usecase-title]");
    const descriptionEl = root.querySelector("[data-usecase-description]");
    const bulletsEl = root.querySelector("[data-usecase-bullets]");
    const imageLabelEl = root.querySelector("[data-usecase-image-label]");
    const imageEl = root.querySelector("[data-usecase-image]");

    if (!tabs.length || !panel) return;

    let activeIndex = 0;

    const render = (nextIndex, moveFocus = false) => {
      activeIndex = Math.max(0, Math.min(items.length - 1, nextIndex));
      const item = items[activeIndex];

      tabs.forEach((tab, index) => {
        const active = index === activeIndex;
        tab.setAttribute("aria-selected", active ? "true" : "false");
        tab.setAttribute("tabindex", active ? "0" : "-1");
        tab.classList.toggle("chip-active", active);
        if (active) {
          panel.setAttribute("aria-labelledby", tab.id);
          if (moveFocus) tab.focus();
        }
      });

      panel.classList.add("opacity-70");
      window.setTimeout(() => {
        if (titleEl) titleEl.textContent = item.name;
        if (descriptionEl) descriptionEl.textContent = item.description;
        if (imageLabelEl) imageLabelEl.textContent = item.imageLabel;
        if (imageEl instanceof HTMLImageElement) {
          imageEl.src = item.image;
          imageEl.alt = `Ukázka prostoru: ${item.name}`;
        }

        if (bulletsEl) {
          bulletsEl.innerHTML = "";
          item.bullets.forEach((bullet) => {
            const li = document.createElement("li");
            li.textContent = bullet;
            bulletsEl.append(li);
          });
        }
        panel.classList.remove("opacity-70");
      }, 80);
    };

    tabs.forEach((tab, index) => {
      tab.addEventListener("click", () => render(index));
      tab.addEventListener("keydown", (event) => {
        let nextIndex = null;
        if (event.key === "ArrowRight") nextIndex = (index + 1) % tabs.length;
        if (event.key === "ArrowLeft") nextIndex = (index - 1 + tabs.length) % tabs.length;
        if (event.key === "Home") nextIndex = 0;
        if (event.key === "End") nextIndex = tabs.length - 1;

        if (nextIndex === null) return;
        event.preventDefault();
        render(nextIndex, true);
      });
    });
  })();
</script>
